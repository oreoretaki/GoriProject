# å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•

**Stage 0 Readyå¯¾å¿œæ¸ˆã¿ - Volumeé™¤å¤–ãƒ»100%æ•´åˆæ€§ä¿è¨¼æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ä½¿ç”¨ã‚¬ã‚¤ãƒ‰**

## ðŸŽ¯ æŽ¨å¥¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•

### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå˜ä¸€æ™‚é–“è»¸ï¼‰

```python
import pandas as pd

def load_safe_ohlc(timeframe='h1', start_date=None, end_date=None):
    """
    Gap-awareå®‰å…¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    - Volumeå®Œå…¨é™¤å¤–æ¸ˆã¿
    - M1ã‹ã‚‰ã®100%æ•´åˆæ€§ä¿è¨¼æ¸ˆã¿
    - Gapå¯¾å¿œãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æœ€é©åŒ–
    - Parqueté«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹
    """
    
    # åˆ©ç”¨å¯èƒ½TF: m5, m15, m30, h1, h4, d
    df = pd.read_parquet(f'../data/derived/simple_gap_aware_{timeframe}.parquet')
    
    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å‡¦ç†
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    df = df.set_index('timestamp').sort_index()
    
    # æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
    if start_date and end_date:
        df = df.loc[start_date:end_date]
    
    return df

# ä½¿ç”¨ä¾‹
df_h1 = load_safe_ohlc('h1', '2024-01-01', '2024-12-31')
print(df_h1.columns)  # Index(['open', 'high', 'low', 'close'], dtype='object')
```

### ãƒžãƒ«ãƒã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†æž

```python
def load_multi_timeframe(timeframes=['m15', 'h1', 'd'], start_date=None, end_date=None):
    """
    è¤‡æ•°æ™‚é–“è»¸ãƒ‡ãƒ¼ã‚¿ã®åŒæ™‚èª­ã¿è¾¼ã¿
    - ã‚¯ãƒ­ã‚¹TFæ•´åˆæ€§100%ä¿è¨¼æ¸ˆã¿
    - Gap-awareå‡¦ç†ã§å®‰å…¨ãªãƒžãƒ«ãƒTFåˆ†æžãŒå¯èƒ½
    """
    
    data = {}
    
    for tf in timeframes:
        df = load_safe_ohlc(tf, start_date, end_date)
        data[tf] = df
        print(f"âœ… {tf.upper()}: {len(df):,}ä»¶èª­ã¿è¾¼ã¿")
    
    return data

# ä½¿ç”¨ä¾‹
multi_data = load_multi_timeframe(['m15', 'h1', 'd'], '2024-01-01', '2024-06-30')

# å„æ™‚é–“è»¸ã§ã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æž
df_m15 = multi_data['m15']
df_h1 = multi_data['h1'] 
df_d = multi_data['d']
```

### ç‰¹å¾´é‡ç”Ÿæˆï¼ˆVolumeå®Œå…¨é™¤å¤–ï¼‰

```python
def generate_safe_features(df):
    """
    Volumeä½¿ç”¨ã›ãšã«å®‰å…¨ãªç‰¹å¾´é‡ç”Ÿæˆ
    - OHLCä¾¡æ ¼ã®ã¿ä½¿ç”¨
    - Volumeæ±šæŸ“ãªã—
    """
    
    # åŸºæœ¬ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™
    df['sma20'] = df['close'].rolling(20).mean()
    df['sma50'] = df['close'].rolling(50).mean()
    df['ema12'] = df['close'].ewm(span=12).mean()
    df['ema26'] = df['close'].ewm(span=26).mean()
    
    # ä¾¡æ ¼ãƒ™ãƒ¼ã‚¹æŒ‡æ¨™
    df['hl_ratio'] = (df['high'] - df['low']) / df['close']
    df['oc_ratio'] = (df['open'] - df['close']) / df['close']
    df['typical_price'] = (df['high'] + df['low'] + df['close']) / 3
    df['price_range'] = df['high'] - df['low']
    
    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æŒ‡æ¨™
    df['atr14'] = calculate_atr(df['high'], df['low'], df['close'], 14)
    df['bb_upper'], df['bb_lower'] = bollinger_bands(df['close'], 20, 2)
    
    # RSIï¼ˆä¾¡æ ¼ã®ã¿ï¼‰
    df['rsi14'] = calculate_rsi(df['close'], 14)
    
    # MACDï¼ˆä¾¡æ ¼ã®ã¿ï¼‰
    df['macd'] = df['ema12'] - df['ema26']
    df['macd_signal'] = df['macd'].ewm(span=9).mean()
    df['macd_histogram'] = df['macd'] - df['macd_signal']
    
    return df

def calculate_atr(high, low, close, period=14):
    """Average True Rangeè¨ˆç®—ï¼ˆVolumeä¸ä½¿ç”¨ï¼‰"""
    tr1 = high - low
    tr2 = abs(high - close.shift(1))
    tr3 = abs(low - close.shift(1))
    
    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
    return tr.rolling(period).mean()

def calculate_rsi(close, period=14):
    """RSIè¨ˆç®—ï¼ˆä¾¡æ ¼ã®ã¿ï¼‰"""
    delta = close.diff()
    gain = (delta.where(delta > 0, 0)).rolling(period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))

def bollinger_bands(close, period=20, std_dev=2):
    """ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ï¼ˆä¾¡æ ¼ã®ã¿ï¼‰"""
    sma = close.rolling(period).mean()
    std = close.rolling(period).std()
    upper = sma + (std * std_dev)
    lower = sma - (std * std_dev)
    return upper, lower

# ä½¿ç”¨ä¾‹
df = load_safe_ohlc('h1', '2024-01-01', '2024-12-31')
df_with_features = generate_safe_features(df)
```

### ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼çµ±åˆ

```python
class SafeOHLCDataLoader:
    """Stage 0å¯¾å¿œ å®‰å…¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼"""
    
    def __init__(self, data_dir='../data/derived'):
        self.data_dir = data_dir
        
    def get_available_timeframes(self):
        """åˆ©ç”¨å¯èƒ½ãªæ™‚é–“è»¸ä¸€è¦§"""
        import glob
        files = glob.glob(f'{self.data_dir}/safe_ohlc_*.parquet')
        tfs = [f.split('_')[-1].replace('.parquet', '') for f in files]
        return sorted(tfs)
    
    def load_timeframe(self, tf, start_date=None, end_date=None, features=True):
        """æŒ‡å®šæ™‚é–“è»¸ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿"""
        
        df = pd.read_parquet(f'{self.data_dir}/simple_gap_aware_{tf}.parquet')
        df['timestamp'] = pd.to_datetime(df['timestamp'])
        df = df.set_index('timestamp').sort_index()
        
        if start_date and end_date:
            df = df.loc[start_date:end_date]
            
        if features:
            df = generate_safe_features(df)
            
        return df
    
    def get_data_info(self):
        """ãƒ‡ãƒ¼ã‚¿æƒ…å ±ã‚µãƒžãƒªãƒ¼"""
        info = {}
        for tf in self.get_available_timeframes():
            df = pd.read_parquet(f'{self.data_dir}/simple_gap_aware_{tf}.parquet')
            info[tf] = {
                'records': len(df),
                'start': df['timestamp'].min(),
                'end': df['timestamp'].max(),
                'columns': list(df.columns),
                'has_volume': 'volume' in df.columns  # ã“ã‚Œã¯Falseã§ã‚ã‚‹ã¹ã
            }
        return info

# ä½¿ç”¨ä¾‹
loader = SafeOHLCDataLoader()

# åˆ©ç”¨å¯èƒ½TFç¢ºèª
print("åˆ©ç”¨å¯èƒ½TF:", loader.get_available_timeframes())

# ãƒ‡ãƒ¼ã‚¿æƒ…å ±ç¢ºèª
info = loader.get_data_info()
for tf, details in info.items():
    print(f"{tf.upper()}: {details['records']:,}ä»¶ "
          f"(Volume: {'âŒé™¤å¤–' if not details['has_volume'] else 'âš ï¸å­˜åœ¨'})")

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
df_h1 = loader.load_timeframe('h1', '2024-01-01', '2024-06-30', features=True)
```

## ðŸš« ä½¿ç”¨ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³

### âŒ å…ƒSQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç›´æŽ¥ä½¿ç”¨

```python
# âŒ çµ¶å¯¾ã«ä½¿ç”¨ç¦æ­¢
import sqlite3

conn = sqlite3.connect('../data/oanda_historical.db')

# ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ•´åˆæ€§ãŒç ´ç¶»ã—ã¦ã„ã‚‹ï¼ˆ0-3%ï¼‰
df = pd.read_sql('SELECT * FROM candles_m5', conn)  # âŒ æ•´åˆæ€§0.3-0.6%
df = pd.read_sql('SELECT * FROM candles_h1', conn)  # âŒ æ•´åˆæ€§0.3-0.6%

# volumeã‚«ãƒ©ãƒ ã‚‚å«ã¾ã‚Œã¦ã—ã¾ã†
df = pd.read_sql('SELECT * FROM candles_m1', conn)  # âŒ volumeæ±šæŸ“
```

### âŒ Volumeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½¿ç”¨

```python
# âŒ volumeä½¿ç”¨ã®ä¾‹ï¼ˆçµ¶å¯¾ç¦æ­¢ï¼‰
df['volume_sma'] = df['volume'].rolling(20).mean()  # âŒ æ„å‘³ã®ãªã„è¨ˆç®—
df['vwap'] = (df['close'] * df['volume']).sum() / df['volume'].sum()  # âŒ å½ã®VWAP
df['volume_ratio'] = df['volume'] / df['volume'].rolling(20).mean()  # âŒ ãƒ†ã‚£ãƒƒã‚¯æ•°æ¯”
```

## âœ… å“è³ªä¿è¨¼

### è‡ªå‹•æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```python
def verify_data_integrity():
    """ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºèª"""
    
    loader = SafeOHLCDataLoader()
    
    for tf in loader.get_available_timeframes():
        df = loader.load_timeframe(tf, features=False)
        
        # Volumeé™¤å¤–ç¢ºèª
        has_volume = 'volume' in df.columns
        
        # OHLCæ•´åˆæ€§ç¢ºèª
        ohlc_valid = (
            (df['low'] <= df['high']) &
            (df['high'] >= df['open']) &
            (df['high'] >= df['close']) &
            (df['low'] <= df['open']) &
            (df['low'] <= df['close'])
        ).all()
        
        print(f"âœ… {tf.upper()}: Volumeé™¤å¤–={'âœ“' if not has_volume else 'âœ—'}, "
              f"OHLCæ•´åˆæ€§={'âœ“' if ohlc_valid else 'âœ—'}")

# å®šæœŸçš„ãªå“è³ªãƒã‚§ãƒƒã‚¯æŽ¨å¥¨
verify_data_integrity()
```

## ðŸ“Š æŽ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

1. **ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿**: `load_safe_ohlc()` ã¾ãŸã¯ `SafeOHLCDataLoader` ä½¿ç”¨
2. **ç‰¹å¾´é‡ç”Ÿæˆ**: `generate_safe_features()` ã§Volumeé™¤å¤–ç‰¹å¾´é‡
3. **ãƒžãƒ«ãƒTFåˆ†æž**: æ•´åˆæ€§ä¿è¨¼æ¸ˆã¿ãªã®ã§å®‰å…¨ã«çµåˆå¯èƒ½
4. **å“è³ªãƒã‚§ãƒƒã‚¯**: å®šæœŸçš„ãª `verify_data_integrity()` å®Ÿè¡Œ

**ðŸŽ¯ Stage 0å‰å‡¦ç†ãƒ»å­¦ç¿’ã®å®‰å…¨ãªå®Ÿè¡ŒãŒä¿è¨¼ã•ã‚Œã¾ã™**