name: Data Hash Integrity Check

on:
  push:
    branches: [ main, master ]
    paths:
      - 'data/derived/**'
      - 'reports/hash_manifest.json'
      - 'scripts/run_validate.py'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'data/derived/**'
      - 'reports/hash_manifest.json'
      - 'scripts/run_validate.py'

jobs:
  data-integrity-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas pyarrow
        
    - name: Check hash manifest exists
      run: |
        if [ ! -f "reports/hash_manifest.json" ]; then
          echo "âŒ reports/hash_manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… reports/hash_manifest.json ç¢ºèªå®Œäº†"
        
    - name: Verify data file integrity
      run: |
        python3 -c "
import hashlib
import json
import sys
from pathlib import Path

def calculate_md5(file_path):
    hash_md5 = hashlib.md5()
    with open(file_path, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b''):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()

# ãƒžãƒ‹ãƒ•ã‚§ã‚¹ãƒˆèª­ã¿è¾¼ã¿
with open('reports/hash_manifest.json') as f:
    manifest = json.load(f)

print('ðŸ” ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§æ¤œè¨¼é–‹å§‹')
print('=' * 40)

all_passed = True

for file_path, expected in manifest['files'].items():
    path_obj = Path(file_path)
    
    if not path_obj.exists():
        print(f'âŒ {file_path}: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
        all_passed = False
        continue
    
    actual_hash = calculate_md5(path_obj)
    expected_hash = expected['md5']
    
    if actual_hash == expected_hash:
        print(f'âœ… {file_path}: OK ({actual_hash[:8]}...)')
    else:
        print(f'âŒ {file_path}: ãƒãƒƒã‚·ãƒ¥ä¸ä¸€è‡´')
        print(f'   æœŸå¾…å€¤: {expected_hash}')
        print(f'   å®Ÿéš›å€¤: {actual_hash}')
        all_passed = False

if all_passed:
    print()
    print('ðŸŽ¯ å…¨ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼åˆæ ¼')
    print('ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: âœ… OK')
else:
    print()
    print('ðŸš¨ ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ')
    sys.exit(1)
        "
        
    - name: Run Stage 0 validation tests
      run: |
        python3 scripts/run_validate.py
        
    - name: Run boundary unit tests
      run: |
        python3 tests/test_boundary.py
        
    - name: Check file permissions and structure
      run: |
        echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèª:"
        ls -la data/derived/
        echo ""
        echo "ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª:"
        du -sh data/derived/*
        
    - name: Generate integrity report
      run: |
        echo "# Stage 0 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ¬ãƒãƒ¼ãƒˆ" > integrity_report.md
        echo "" >> integrity_report.md
        echo "**ç”Ÿæˆæ—¥æ™‚**: $(date)" >> integrity_report.md
        echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> integrity_report.md
        echo "" >> integrity_report.md
        echo "## æ¤œè¨¼çµæžœ" >> integrity_report.md
        echo "- âœ… ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼: åˆæ ¼" >> integrity_report.md
        echo "- âœ… Stage 0ãƒ†ã‚¹ãƒˆ: åˆæ ¼" >> integrity_report.md
        echo "- âœ… å¢ƒç•Œãƒ†ã‚¹ãƒˆ: åˆæ ¼" >> integrity_report.md
        echo "" >> integrity_report.md
        echo "## ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> integrity_report.md
        echo "\`\`\`" >> integrity_report.md
        ls -la data/derived/ >> integrity_report.md
        echo "\`\`\`" >> integrity_report.md
        
    - name: Upload integrity report
      uses: actions/upload-artifact@v3
      with:
        name: stage0-integrity-report
        path: integrity_report.md
        retention-days: 30